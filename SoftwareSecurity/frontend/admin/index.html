<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Vulnerable Banking App</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Admin Dashboard</h1>
            <div id="admin-info" class="hidden">
                <span id="admin-username-display"></span>
                <button id="admin-logout-btn">Logout</button>
            </div>
        </header>

        <main>
            <!-- Admin Login Form -->
            <section id="admin-login-section">
                <h2>Admin Login</h2>
                <form id="admin-login-form">
                    <div class="form-group">
                        <label for="admin-username">Username:</label>
                        <input type="text" id="admin-username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="admin-password">Password:</label>
                        <input type="password" id="admin-password" name="password" required>
                    </div>
                    <button type="submit">Login</button>
                </form>
                <div id="admin-login-message"></div>
            </section>

            <!-- Admin Dashboard -->
            <section id="admin-dashboard-section" class="hidden">
                <div class="admin-panel">
                    <div class="admin-sidebar">
                        <h3>Navigation</h3>
                        <ul>
                            <li><a href="#" class="active" data-section="messages-section">User Messages</a></li>
                            <li><a href="#" data-section="logs-section">Action Logs</a></li>
                            <li><a href="#" data-section="system-section">System Check</a></li>
                            <li><a href="#" data-section="complaints-section">User Complaints</a></li>
                        </ul>
                    </div>
                    
                    <div class="admin-content">
                        <!-- Messages Section -->
                        <div id="messages-section" class="admin-content-section">
                            <h2>User Messages</h2>
                            <div id="messages-container"></div>
                        </div>
                        
                        <!-- Logs Section -->
                        <div id="logs-section" class="admin-content-section hidden">
                            <h2>Action Logs</h2>
                            <div id="logs-container"></div>
                        </div>
                        
                        <!-- System Check Section -->
                        <div id="system-section" class="admin-content-section hidden">
                            <h2>System Check</h2>
                            <!-- VULNERABILITY: Command Injection -->
                            <form id="system-check-form">
                                <div class="form-group">
                                    <label for="system-command">Run System Command:</label>
                                    <input type="text" id="system-command" name="command" placeholder="Enter command...">
                                </div>
                                <button type="submit">Execute</button>
                            </form>
                            <div id="command-output" class="command-output"></div>
                        </div>
                        
                        <!-- Complaints Section -->
                        <div id="complaints-section" class="admin-content-section hidden">
                            <h2>User Complaints</h2>
                            <div id="complaints-container"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>WARNING: This is a deliberately vulnerable application for educational purposes only.</p>
        </footer>
    </div>

    <script>
        // Admin Dashboard JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const adminLoginSection = document.getElementById('admin-login-section');
            const adminDashboardSection = document.getElementById('admin-dashboard-section');
            const adminInfo = document.getElementById('admin-info');
            const adminUsernameDisplay = document.getElementById('admin-username-display');
            const adminLoginForm = document.getElementById('admin-login-form');
            const adminLoginMessage = document.getElementById('admin-login-message');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            const messagesContainer = document.getElementById('messages-container');
            const logsContainer = document.getElementById('logs-container');
            const complaintsContainer = document.getElementById('complaints-container');
            const systemCheckForm = document.getElementById('system-check-form');
            const commandOutput = document.getElementById('command-output');
            
            // Navigation links
            const navLinks = document.querySelectorAll('.admin-sidebar a');
            const contentSections = document.querySelectorAll('.admin-content-section');
            
            // Global variables
            let adminUser = null;
            
            // Initialize
            function init() {
                setupEventListeners();
                
                // Check if admin is already logged in
                const storedAdmin = localStorage.getItem('adminUser');
                if (storedAdmin) {
                    adminUser = JSON.parse(storedAdmin);
                    showAdminDashboard();
                }
            }
            
            // Set up event listeners
            function setupEventListeners() {
                adminLoginForm.addEventListener('submit', handleAdminLogin);
                adminLogoutBtn.addEventListener('click', adminLogout);
                systemCheckForm.addEventListener('submit', runSystemCheck);
                
                // Navigation event listeners
                navLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        // Remove active class from all links
                        navLinks.forEach(l => l.classList.remove('active'));
                        
                        // Add active class to clicked link
                        this.classList.add('active');
                        
                        // Hide all content sections
                        contentSections.forEach(section => section.classList.add('hidden'));
                        
                        // Show selected section
                        const sectionId = this.getAttribute('data-section');
                        document.getElementById(sectionId).classList.remove('hidden');
                        
                        // Load data for the selected section
                        if (sectionId === 'messages-section') {
                            loadMessages();
                        } else if (sectionId === 'logs-section') {
                            loadLogs();
                        } else if (sectionId === 'complaints-section') {
                            loadComplaints();
                        }
                    });
                });
            }
            
            // Handle admin login
            async function handleAdminLogin(e) {
                e.preventDefault();
                
                const username = document.getElementById('admin-username').value;
                const password = document.getElementById('admin-password').value;
                
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // VULNERABILITY: No role verification
                        // Should check if user.role === 'admin'
                        localStorage.setItem('adminUser', JSON.stringify(data));
                        adminUser = data;
                        showAdminDashboard();
                    } else {
                        adminLoginMessage.textContent = data.error || 'Login failed';
                        adminLoginMessage.className = 'error-message';
                    }
                } catch (error) {
                    adminLoginMessage.textContent = 'An error occurred. Please try again.';
                    adminLoginMessage.className = 'error-message';
                    console.error('Admin login error:', error);
                }
            }
            
            // Show admin dashboard
            function showAdminDashboard() {
                adminLoginSection.classList.add('hidden');
                adminDashboardSection.classList.remove('hidden');
                adminInfo.classList.remove('hidden');
                adminUsernameDisplay.textContent = `Admin: ${adminUser.username}`;
                
                // Load initial data
                loadMessages();
            }
            
            // Load user messages
            async function loadMessages() {
                try {
                    // VULNERABILITY: No authentication check
                    const response = await fetch('/api/admin/messages');
                    const messages = await response.json();
                    
                    displayMessages(messages);
                } catch (error) {
                    messagesContainer.innerHTML = '<p class="error-message">Failed to load messages</p>';
                    console.error('Load messages error:', error);
                }
            }
            
            // Display messages
            function displayMessages(messages) {
                if (messages.length === 0) {
                    messagesContainer.innerHTML = '<p>No messages found.</p>';
                    return;
                }
                
                let html = '';
                
                messages.forEach(message => {
                    // VULNERABILITY: XSS - Unsanitized message content
                    html += `
                        <div class="message-item">
                            <div class="message-header">
                                <span class="message-sender">${message.username}</span>
                                <span class="message-date">${new Date(message.date).toLocaleString()}</span>
                            </div>
                            <div class="message-content">${message.message}</div>
                        </div>
                    `;
                });
                
                messagesContainer.innerHTML = html;
            }
            
            // Load admin logs
            async function loadLogs() {
                try {
                    // VULNERABILITY: No authentication check
                    const response = await fetch('/api/admin/logs');
                    const logs = await response.json();
                    
                    displayLogs(logs);
                } catch (error) {
                    logsContainer.innerHTML = '<p class="error-message">Failed to load logs</p>';
                    console.error('Load logs error:', error);
                }
            }
            
            // Display logs
            function displayLogs(logs) {
                if (logs.length === 0) {
                    logsContainer.innerHTML = '<p>No logs found.</p>';
                    return;
                }
                
                let html = '';
                
                logs.forEach(log => {
                    html += `
                        <div class="log-item">
                            <div class="log-header">
                                <span class="log-action">${log.action}</span>
                                <span class="log-user">${log.username}</span>
                                <span class="log-date">${new Date(log.date).toLocaleString()}</span>
                            </div>
                            <div class="log-details">${log.details}</div>
                        </div>
                    `;
                });
                
                logsContainer.innerHTML = html;
            }
            
            // Load complaints
            async function loadComplaints() {
                try {
                    // VULNERABILITY: No authentication check
                    const response = await fetch('/api/admin/complaints');
                    const complaints = await response.json();
                    
                    displayComplaints(complaints || []);
                } catch (error) {
                    complaintsContainer.innerHTML = '<p class="error-message">Failed to load complaints</p>';
                    console.error('Load complaints error:', error);
                }
            }
            
            // Display complaints
            function displayComplaints(complaints) {
                if (complaints.length === 0) {
                    complaintsContainer.innerHTML = '<p>No complaints found.</p>';
                    return;
                }
                
                let html = '';
                
                complaints.forEach(complaint => {
                    html += `
                        <div class="complaint-item">
                            <div class="complaint-header">
                                <span class="complaint-subject">${complaint.subject}</span>
                                <span class="complaint-status">${complaint.status}</span>
                                <span class="complaint-date">${new Date(complaint.date).toLocaleString()}</span>
                            </div>
                            <div class="complaint-description">${complaint.description}</div>
                            ${complaint.file_path ? `<div class="complaint-file"><a href="${complaint.file_path}" target="_blank">View Attachment</a></div>` : ''}
                        </div>
                    `;
                });
                
                complaintsContainer.innerHTML = html;
            }
            
            // Run system check (VULNERABILITY: Command Injection)
            async function runSystemCheck(e) {
                e.preventDefault();
                
                const command = document.getElementById('system-command').value;
                
                try {
                    const response = await fetch('/api/admin/system-check', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ command })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        commandOutput.innerHTML = `<pre>${data.output}</pre>`;
                    } else {
                        commandOutput.innerHTML = `<p class="error-message">${data.error}</p>`;
                    }
                } catch (error) {
                    commandOutput.innerHTML = `<p class="error-message">An error occurred: ${error.message}</p>`;
                    console.error('System check error:', error);
                }
            }
            
            // Admin logout
            function adminLogout() {
                localStorage.removeItem('adminUser');
                adminUser = null;
                
                // Reset and hide sections
                adminLoginForm.reset();
                adminLoginMessage.textContent = '';
                adminLoginMessage.className = '';
                adminDashboardSection.classList.add('hidden');
                adminInfo.classList.add('hidden');
                adminLoginSection.classList.remove('hidden');
                
                // Reset content sections
                messagesContainer.innerHTML = '';
                logsContainer.innerHTML = '';
                complaintsContainer.innerHTML = '';
                commandOutput.innerHTML = '';
            }
            
            // Initialize the admin dashboard
            init();
        });
    </script>
</body>
</html>